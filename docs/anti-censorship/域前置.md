---
title: "域前置"
description:
published: true
date: "2024-06-12T00:16:50"
特殊标签标记: #无标签
editor: markdown
dateCreated: "2024-02-07T12:28:35"
---

## 简介

TLS 握手时发送的 Client Hello 消息，通常会包含 SNI 扩展信息，这个信息含有网站域名，所以 GFW 等审查防火墙能识别用户连接的网站，并且对部分网站进行 RST，发送终止连接的信号。

<ruby>域前置<rt>Domain fronting</rt></ruby>是发送虚假或空白 SNI 给服务器的反审查方案。[^wiki] 由于 SNI 本身属于扩展协议，所以不正确的 SNI 或者没有 SNI，可能会触发服务器的兼容性功能，从而返回默认的或通用的证书，允许连接建立。（属于一种向前兼容）

[^wiki]: https://en.wikipedia.org/wiki/Domain_fronting

## 将 SNI 加密

不过部分群体自己调整 TLS 协议的 SNI 扩展部分，以不被中间人攻击。还是从上层扩展 TLS 协议，直接修补漏洞才是更好的方案。

2018年8月12日，<ruby>互联网工程任务组<rt>IETF</rt></ruby>编写了 Encrypted Server Name Indication for TLS 1.3 草案（简称 ESNI），
用来解决 SNI 被明文传输的问题。[^61954]

[^61954]: Eric Rescorla, Kazuho Oku, Nick Sullivan 与 Christopher A. Wood, [Encrypted Server Name Indication for TLS 1.3](https://web.archive.org/web/20240108061954/https://datatracker.ietf.org/doc/html/draft-ietf-tls-esni-00), Internet Engineering Task Force, Internet Draft draft-ietf-tls-esni-00, 9月 2018. 参照: 2024-06-11. [Online].

2018年9月24日，在草案完成后不久，Cloudflare 就率先支持了 ESNI。[^53948]
Mozilla 也在 2018年10月18日，在 Firefox Nightly 中支持了 ESNI（须在 `about:config` 里手动开启）。[^90628]

[^53948]: Matthew Prince, [Encrypting SNI: Fixing One of the Core Internet Bugs](https://web.archive.org/web/20180924153948/https://blog.cloudflare.com/esni/), The Cloudflare Blog, 2018-09-24. (参照 2024-06-11).

[^90628]: Eric Rescorla, 《[Encrypted SNI Comes to Firefox Nightly](https://web.archive.org/web/20231216090628/https://blog.mozilla.org/security/2018/10/18/encrypted-sni-comes-to-firefox-nightly/)》, Mozilla Security Blog, 2018-10-18. (参照 2024-06-11).

2020年6月1日，IETF 在第 7 版 ESNI 草案里，转换了方向，将整个 Client Hello 消息给加密起来。
所以就更名为了 TLS Encrypted Client Hello，简称 ECH。[^35656]

[^35656]: Eric Rescorla, Kazuho Oku, Nick Sullivan 与 Christopher A. Wood, [TLS Encrypted Client Hello](https://web.archive.org/web/20240521035656/https://datatracker.ietf.org/doc/html/draft-ietf-tls-esni-07), Internet Engineering Task Force, Internet Draft draft-ietf-tls-esni-07, 6月 2020. 参照: 2024-06-11. [Online].

2020年7月30日，ESNI 被 GFW 封禁，具体情况是含有 ESNI 扩展的 TLS 握手完成后（具体是 0xffce 扩展标识），连接会被切断，
然后该 IP 地址将的 TCP 连接会被阻止 2 或 3 分钟。[^KR6_I][^93713][^febz]

[^KR6_I]: onoketa, [\[TLS\] Possible blocking of Encrypted SNI extension in China](https://web.archive.org/web/20200808071838/https://mailarchive.ietf.org/arch/msg/tls/YzT5LjLJ_6WWhdnU2wVsKNKR6_I/), ietf email, 2020-07-30. (参照 2024-06-11).

[^93713]: iYouPort, 《[报告：中国的防火长城已经封锁加密服务器名称指示（ESNI）](https://web.archive.org/web/20200808093713/https://www.iyouport.org/报告：中国的防火长城已经封锁加密服务器名称指/)》, iYouPort, 2020-08-08. (参照 2024-06-11).

[^febz]: Kevin Bock 等, 《[揭示和规避中国对加密SNI（ESNI）的封锁](https://web.archive.org/web/20231207105611/https://gfw.report/blog/gfw_esni_blocking/zh/)》, GFW Report, 2020-08-06. (参照 2024-02-07).

2020年12月8日，Cloudflare 表示将为 ECH 做好准备，一旦准备好，就不会再支持 ESNI。[^51829]
Mozilla 也在 2021年1月7日 的博客里提到，Firefox 85 里将使用 ECH 取代 ESNI，`about:config` 里的 ESNI 选项将不复存在。[^41351]

[^51829]: Christopher Patton, [Good-bye ESNI, hello ECH!](https://web.archive.org/web/20240508051829/https://blog.cloudflare.com/encrypted-client-hello/), The Cloudflare Blog, 2020-12-08. (参照 2024-06-11).

[^41351]: Kevin Jacobs, [Encrypted Client Hello: the future of ESNI in Firefox](https://web.archive.org/web/20240413041351/https://blog.mozilla.org/security/2021/01/07/encrypted-client-hello-the-future-of-esni-in-firefox/), Mozilla Security Blog, 2021-01-07. (参照 2024-06-11).

Google Chrome 的情况不是很明确，有消息说早在 2020年10月20日，Google Chrome 就为浏览器添加了 ECH 功能，
须在 flags 页面里手动启用。[^81952]

[^81952]: [TLS Encrypted Client Hello (ECH)](https://web.archive.org/web/20201021131324/https://www.chromestatus.com/feature/6196703843581952), Chrome Platform Status, 2020-10-21. (参照 2024-06-11).

2021年10月12日，Cloudflare 开始 TLS ECH 的初步部署，最初的特定地理区域的免费用户，之后将扩展。[^30046]

[^30046]: Christopher Wood 与 Christopher Patton, [Handshake Encryption: Endgame (an ECH update)](https://web.archive.org/web/20240607030046/https://blog.cloudflare.com/handshake-encryption-endgame-an-ech-update), The Cloudflare Blog, 2021-10-12. (参照 2024-06-11).

〔待续〕

2023年9月11日，Google 默认启用了 ECH 功能。[^BAQAJ]

[^BAQAJ]: David Adrian, 《[Intent to Ship: TLS Encrypted Client Hello (ECH)](https://web.archive.org/web/20240221182800/https://groups.google.com/a/chromium.org/g/blink-dev/c/CmlXjQeNWDI/m/hx-_4lNBAQAJ)》, Google Groups, 2024-02-21. (参照 2024-06-11).

2023年9月29日，Cloudflare 为所有免费计划的用户启用了 ECH，这意味着大量网站都启用了 ECH 功能。[^95722]

[^95722]: Achiel van der Mandele, Alessandro Ghedini, Christopher Wood 和 Rushil Mehra, [Encrypted Client Hello - the last puzzle piece to privacy](https://web.archive.org/web/20240604195722/https://blog.cloudflare.com/announcing-encrypted-client-hello/), The Cloudflare Blog, 2023-09-29. (参照 2024-06-11).

## 域前置的后续

2016 年开始，IM 软件 Signal、Telegram 使用了域前置规避审查，来解决被部分地区封锁的问题，2018年4月14日，
由于俄罗斯大规模封禁 Google 和 Amazon 云的 IP，尝试禁止这些软件，所以 Google 和 Amazon 禁用了域前置，
云运营商给出的理由是「安全问题」。这标志依附的自由策略逐渐失效。[^df]

[^df]: <https://en.wikipedia.org/wiki/Domain_fronting>

## 域前置浏览器

通常域前置被作为一些软件独特的反审查方式，不过有开发者觉得域前置可以直接添加到浏览器上，这样就相当于一种翻墙浏览器。

revolter-firefox 就是这样的浏览器，开发者 Xmader 魔改了网络安全相关的二进制文件，使其默认不发送 SNI。[^55039]

[^55039]: Xu-Ming, [revolter-firefox/revolter-firefox](https://web.archive.org/web/20230912055039/https://github.com/revolter-firefox/revolter-firefox),. revolter-firefox, 2024-02-04. 参照: 2024-02-07. [Online].

然而开发者在 2019年10月 前删库，原因不明。[^1360]

<!-- 根据后来的 [采访](/anti-censorship/Fuck-XueXiQiangGuo.md#开发者被攻击) 来看，可能还是有一些外部压力的因素。 -->

[^1360]: 095448a, 《[解决 SNI RST 的新方式](https://web.archive.org/web/20240207032829/https://2047.one/t/1360)》, 2047, 2019-07-27. (参照 2024-02-07).

## Chromium 启动项

有开发者，继续开发了简单、通用的 Windows SNI 伪装工具：[Sheas-Cealer](https://github.com/SpaceTimee/Sheas-Cealer)。
一个软件加上 Chromium 系列浏览器，配置也很简单，就能实现裸连 Google、Pixiv、Steam 和 Telegram 的效果，
并且能轻松添加新域名。

原理是 Chromium 系列的 `--host-rules` 参数：

```shell
chrome.exe --host-rules="MAP example.com example.org" --host-resolver-rules="MAP example.org 192.0.2.0" --test-type --ignore-certificate-errors
```

上面的启动项里，将 `example.com` 映射到 `example.org`，然后 `example.org` 解析到 IP `192.0.2.0`，最后是忽略证书错误。
但是不知道是错误还是特性，浏览器会发送 `example.org` 的 SNI 扩展信息请求，从而实现轻松伪装 SNI。

Sheas-Cealer GitHub 仓库地址：<https://github.com/SpaceTimee/Sheas-Cealer>。需要注意的是，软件 UI 不够易懂，
需要点击左上角的按钮，切换到「文件路径」，填写浏览器的路径才能开始使用。

附言：SNI 伪装工具还有 [Accesser](https://github.com/URenko/Accesser) 和 [GotoX](https://github.com/SeaHOH/GotoX)，
但是用法相对复杂一些，可能需要多种软件配合使用。

附言 2：原理真的很简单，GPT-4o 也可以轻松制作一个网页版：[Chrome 域前置启动项生成器][]，
填入 Sheas-Cealer 的 [YAML 格式规则](https://github.com/SpaceTimee/Cealing-Host/blob/main/Cealing-Host-A.json)，
应该就能在其他平台使用了。

[Chrome 域前置启动项生成器]: https://gistpreview.github.io/?22ce3b5da2a6684423891959dc5c02f8/chrome_domain_fronting_launch_command_generator.html

<!-- 写于 2024-06-09 -->
